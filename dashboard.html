<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æµ·æˆ°æƒ…å®¤ | å…¨èƒ½å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #0f172a; color: #e2e8f0; } /* æ”¹ç‚ºæ·±è‰²ä¸»é¡Œ */
        .login-screen { display: flex; }
        .dashboard-screen { display: none; }
        .input-dark {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: white;
        }
        .input-dark:focus {
            border-color: #6366f1;
            outline: none;
        }
        @keyframes shine {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }
        .ai-loading {
            background: linear-gradient(to right, #db2777 20%, #f472b6 40%, #f472b6 60%, #db2777 80%);
            background-size: 200% auto;
            animation: shine 2s linear infinite;
            pointer-events: none;
        }
        /* åœ–ç‰‡é è¦½è¦–çª— */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            margin: 2% auto;
            padding: 20px;
            width: 95%;
            max-width: 600px;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- 1. ç™»å…¥ç•«é¢ -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center login-screen px-4 bg-slate-900">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-900/50">
                    <i class="fas fa-user-astronaut text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">å°æµ·æˆ°æƒ…å®¤</h2>
                <p class="text-slate-400 text-sm mt-2">è«‹è¼¸å…¥æŒ‡æ®å®˜å¯†ç¢¼</p>
            </div>
            <div class="space-y-4">
                <div>
                    <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼..." 
                        class="w-full px-4 py-3 rounded-lg bg-slate-700 border border-slate-600 text-white focus:ring-2 focus:ring-blue-500 outline-none transition text-center tracking-widest text-lg">
                </div>
                <button onclick="checkLogin()" 
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition duration-200 transform active:scale-95 shadow-lg">
                    é©—è­‰èº«åˆ†
                </button>
                <div class="text-center">
                    <a href="index.html" class="text-sm text-slate-500 hover:text-slate-300">å›å‰å°é¦–é </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ç™¼æ–‡å¾Œå° -->
    <div id="dashboardSection" class="min-h-screen dashboard-screen flex-col pb-20">
        <!-- Navbar -->
        <nav class="bg-slate-800 shadow-lg border-b border-slate-700 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-2">
                <i class="fas fa-chart-network text-blue-500"></i>
                <h1 class="font-bold text-white text-lg tracking-wider">å°æµ·æˆ°æƒ…ä¸­å¿ƒ</h1>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleApiKeyInput()" class="text-slate-400 hover:text-purple-400 text-sm font-medium transition flex items-center gap-1" title="è¨­å®š AI Key">
                    <i class="fas fa-robot"></i> <span class="hidden md:inline">AI è¨­å®š</span>
                </button>
                <a href="index.html" class="text-slate-400 hover:text-blue-400 text-sm font-medium transition flex items-center gap-1">
                    <i class="fas fa-globe"></i> <span class="hidden md:inline">ç¶²ç«™é è¦½</span>
                </a>
                <button onclick="logout()" class="text-slate-400 hover:text-red-400 text-sm font-medium transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </nav>

        <!-- API Key è¨­å®šå€å¡Š -->
        <div id="apiKeySection" class="hidden bg-slate-900 border-b border-purple-900/30 p-4">
            <div class="max-w-4xl mx-auto flex gap-2 items-center">
                <i class="fas fa-key text-purple-500"></i>
                <input type="password" id="geminiApiKey" placeholder="åœ¨æ­¤è²¼ä¸Š Gemini API Key" class="flex-1 px-3 py-2 rounded bg-slate-800 border border-slate-700 text-sm text-white focus:outline-none focus:border-purple-500">
                <button onclick="saveApiKey()" class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-500">å„²å­˜</button>
            </div>
        </div>

        <main class="flex-1 max-w-5xl w-full mx-auto p-4 md:p-6 space-y-6">
            
            <!-- (åŠŸèƒ½ 4) ğŸ§® å°æµ·ç­–ç•¥è¨ˆç®—æ©Ÿ -->
            <div class="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden">
                <div class="p-4 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center cursor-pointer" onclick="toggleCalc()">
                    <h3 class="font-bold text-blue-400 flex items-center gap-2">
                        <i class="fas fa-calculator"></i> å°æµ·ç­–ç•¥è¨ˆç®—æ©Ÿ (5åˆ†K)
                    </h3>
                    <i class="fas fa-chevron-down text-slate-500"></i>
                </div>
                <div id="calcBody" class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">æ—©ç›¤ç¬¬ä¸€æ ¹ 5åˆ†K é«˜é»</label>
                            <input type="number" id="kHigh" class="w-full px-3 py-2 rounded bg-slate-700 border border-slate-600 text-white text-center font-mono" placeholder="High">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">æ—©ç›¤ç¬¬ä¸€æ ¹ 5åˆ†K ä½é»</label>
                            <input type="number" id="kLow" class="w-full px-3 py-2 rounded bg-slate-700 border border-slate-600 text-white text-center font-mono" placeholder="Low">
                        </div>
                        <button onclick="calculateStrategy()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition">è¨ˆç®—é»ä½</button>
                    </div>
                    <div class="md:col-span-2 bg-slate-900 rounded-xl p-4 border border-slate-700 font-mono text-sm relative">
                        <div id="calcResult" class="text-slate-400 text-center py-8">è«‹è¼¸å…¥é«˜ä½é»å¾ŒæŒ‰ä¸‹è¨ˆç®—</div>
                        <button onclick="copyCalcResult()" class="absolute top-2 right-2 text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded hover:bg-slate-600 hidden" id="copyCalcBtn">è¤‡è£½</button>
                    </div>
                </div>
            </div>

            <!-- æ’°å¯«å€å¡Š -->
            <div class="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden">
                <div class="p-4 border-b border-slate-700 bg-slate-800/50 flex flex-wrap gap-3 justify-between items-center">
                    <h3 class="font-bold text-white">æ’°å¯«æˆ°å ±</h3>
                    <div class="flex gap-2 flex-wrap">
                         <!-- (åŠŸèƒ½ 2 & 4) åœ–æ–‡ç”ŸæˆæŒ‰éˆ• -->
                         <button id="textGenBtn" onclick="generateSocialText()" class="bg-green-600 hover:bg-green-500 text-white text-xs md:text-sm font-bold py-1.5 px-3 rounded-full shadow transition flex items-center gap-1">
                            <i class="fab fa-line"></i> ç”ŸæˆçŸ­æ–‡
                        </button>
                         <button id="imgGenBtn" onclick="generateSocialImage()" class="bg-pink-600 hover:bg-pink-500 text-white text-xs md:text-sm font-bold py-1.5 px-3 rounded-full shadow transition flex items-center gap-1">
                            <i class="fas fa-image"></i> ç”Ÿæˆé»‘å¡
                        </button>
                        <button id="aiRewriteBtn" onclick="rewriteWithAI()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white text-xs md:text-sm font-bold py-1.5 px-3 rounded-full shadow transition flex items-center gap-1">
                            <i class="fas fa-magic"></i> AI æ’ç‰ˆ
                        </button>
                    </div>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- æ¨™é¡Œ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æ–‡ç« æ¨™é¡Œ</label>
                        <input type="text" id="postTitle" class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ã€å°æµ·è§€å¯Ÿå®¤ã€‘2025/12/11...">
                    </div>

                    <!-- åˆ†é¡ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æˆ°å ±åˆ†é¡</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="category" value="ç›¤å‰åˆ†æ" class="peer sr-only" checked>
                                <div class="text-center py-2 border border-slate-600 rounded-lg text-slate-400 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-slate-700 transition">ç›¤å‰åˆ†æ</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="category" value="ç›¤å¾Œåˆ†æ" class="peer sr-only">
                                <div class="text-center py-2 border border-slate-600 rounded-lg text-slate-400 peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-slate-700 transition">ç›¤å¾Œåˆ†æ</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="category" value="å‘¨æœ«åˆ†æ" class="peer sr-only">
                                <div class="text-center py-2 border border-slate-600 rounded-lg text-slate-400 peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600 hover:bg-slate-700 transition">å‘¨æœ«åˆ†æ</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="category" value="å¿ƒæ…‹åˆ†äº«" class="peer sr-only">
                                <div class="text-center py-2 border border-slate-600 rounded-lg text-slate-400 peer-checked:bg-amber-600 peer-checked:text-white peer-checked:border-amber-600 hover:bg-slate-700 transition">å¿ƒæ…‹åˆ†äº«</div>
                            </label>
                        </div>
                    </div>

                    <!-- (åŠŸèƒ½ 2) åœ–ç‰‡æ’å…¥æŒ‰éˆ• (ç°¡æ˜“ç‰ˆ) -->
                    <div>
                        <button onclick="insertImagePrompt()" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1 mb-2">
                            <i class="fas fa-link"></i> æ’å…¥åœ–ç‰‡é€£çµ (Kç·šåœ–/å°å¸³å–®)
                        </button>
                        <textarea id="postContent" rows="15" class="w-full px-4 py-3 rounded-lg bg-slate-700 border border-slate-600 text-white focus:ring-2 focus:ring-blue-500 outline-none resize-y font-sans text-base leading-relaxed" placeholder="è«‹è¼¸å…¥å¸‚å ´æ•¸æ“šã€ç­†è¨˜æˆ–è‰ç¨¿ï¼ŒAI æœƒå¹«æ‚¨çµ±æ•´..."></textarea>
                    </div>

                    <button id="submitBtn" onclick="submitPost()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-900/50 transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                        <i class="fas fa-paper-plane"></i> ç™¼å¸ƒæˆ°å ±
                    </button>
                </div>
            </div>

            <!-- (åŠŸèƒ½ 3) æ–‡ç« ç®¡ç†åˆ—è¡¨ -->
            <div class="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden">
                <div class="p-6 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i class="fas fa-history"></i> æ­·å²æˆ°å ±ç®¡ç†
                    </h3>
                    <button onclick="loadMyPosts()" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="postsList" class="divide-y divide-slate-700">
                    <div class="p-8 text-center text-slate-500 text-sm">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

        </main>
    </div>

    <!-- åœ–ç‰‡/æ–‡æ¡ˆ é è¦½è¦–çª— -->
    <div id="modalOverlay" class="modal">
        <div class="modal-content">
            <div class="bg-slate-800 p-4 rounded-xl shadow-2xl inline-block relative border border-slate-600 w-full">
                <button onclick="closeModal()" class="absolute -top-4 -right-4 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-red-600 z-50">
                    <i class="fas fa-times"></i>
                </button>
                
                <!-- å…§å®¹å®¹å™¨ -->
                <div id="modalBody"></div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot, deleteDoc, doc } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const firebaseConfig = {
            apiKey: "AIzaSyB3_iiersG3Fff4oj_ouyu_lLs3flzPmKE",
            authDomain: "littlesea-web.firebaseapp.com",
            projectId: "littlesea-web",
            storageBucket: "littlesea-web.firebasestorage.app",
            messagingSenderId: "796678723012",
            appId: "1:796678723012:web:6c501411714c2f49960091",
            measurementId: "G-W8GSXYYY9L"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user) { loadMyPosts(); } 
            else { signInAnonymously(auth); }
        });

        // 1. æ–‡ç« åˆ—è¡¨ & åˆªé™¤
        window.loadMyPosts = function() {
            const listContainer = document.getElementById('postsList');
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(10));
            
            onSnapshot(q, (snapshot) => {
                listContainer.innerHTML = '';
                if (snapshot.empty) {
                    listContainer.innerHTML = '<div class="p-8 text-center text-slate-500 text-sm">ç›®å‰æ²’æœ‰æ–‡ç« </div>';
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const post = docSnap.data();
                    const date = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString('zh-TW', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}) : 'è™•ç†ä¸­';
                    const id = docSnap.id;

                    const item = document.createElement('div');
                    item.className = "p-4 hover:bg-slate-700/50 transition flex justify-between items-center group";
                    item.innerHTML = `
                        <div class="flex-1 min-w-0 pr-4">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-blue-900 text-blue-200 border border-blue-800">${post.category}</span>
                                <span class="text-xs text-slate-400 font-mono">${date}</span>
                            </div>
                            <h4 class="text-sm font-bold text-slate-200 truncate">${post.title}</h4>
                        </div>
                        <button onclick="deletePost('${id}')" class="text-slate-500 hover:text-red-400 p-2 rounded-full hover:bg-slate-700 transition" title="åˆªé™¤æ–‡ç« ">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    listContainer.appendChild(item);
                });
            });
        }

        window.deletePost = async function(docId) {
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æˆ°å ±å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚")) {
                try { await deleteDoc(doc(db, "posts", docId)); } 
                catch (e) { alert("åˆªé™¤å¤±æ•—ï¼š" + e.message); }
            }
        }

        // 2. å°æµ·ç­–ç•¥è¨ˆç®—æ©Ÿ
        window.toggleCalc = function() {
            const body = document.getElementById('calcBody');
            body.classList.toggle('hidden');
        }
        
        window.calculateStrategy = function() {
            const h = parseFloat(document.getElementById('kHigh').value);
            const l = parseFloat(document.getElementById('kLow').value);
            
            if (!h || !l) { alert("è«‹è¼¸å…¥é«˜ä½é»"); return; }
            
            const range = h - l;
            // ç­–ç•¥é‚è¼¯ (æ¨¡æ“¬)ï¼š
            // çªç ´åƒ¹: High + Range * 0.382 (èˆ‰ä¾‹)
            // 5Tæ¸›ç¢¼: Low (è‹¥è·Œç ´)
            const breakout = (h + (range * 0.382)).toFixed(1); 
            const stopLoss = l.toFixed(1);
            
            // äº”æª”æ”¯æ’å£“åŠ› (ç°¡æ˜“è¨ˆç®—)
            const p1 = (h + range).toFixed(1);
            const p2 = (h + range * 2).toFixed(1);
            const s1 = (l - range).toFixed(1);
            const s2 = (l - range * 2).toFixed(1);

            const resultHtml = `
                <div class="text-left space-y-2">
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span class="text-red-400">ğŸ”¥ çªç ´ç©æ¥µåƒ¹</span> <span class="font-bold text-white">${breakout}</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span class="text-yellow-400">ğŸ›¡ï¸ 5T æ¸›ç¢¼é˜²å®ˆ</span> <span class="font-bold text-white">${stopLoss}</span></div>
                    <div class="mt-4 text-xs text-slate-500">åƒè€ƒå€é–“</div>
                    <div class="flex justify-between"><span class="text-red-300">å£“åŠ› 2</span> <span>${p2}</span></div>
                    <div class="flex justify-between"><span class="text-red-300">å£“åŠ› 1</span> <span>${p1}</span></div>
                    <div class="flex justify-between"><span class="text-green-300">æ”¯æ’ 1</span> <span>${s1}</span></div>
                    <div class="flex justify-between"><span class="text-green-300">æ”¯æ’ 2</span> <span>${s2}</span></div>
                </div>
            `;
            document.getElementById('calcResult').innerHTML = resultHtml;
            document.getElementById('copyCalcBtn').classList.remove('hidden');
        }

        // 3. AI æ ¸å¿ƒé‚è¼¯
        window.toggleApiKeyInput = function() { document.getElementById('apiKeySection').classList.toggle('hidden'); }
        window.saveApiKey = function() {
            const key = document.getElementById('geminiApiKey').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                alert('API Key å·²å„²å­˜ï¼');
                document.getElementById('apiKeySection').classList.add('hidden');
            }
        }
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) document.getElementById('geminiApiKey').value = savedKey;

        async function getGeminiModel() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) { alert("è«‹å…ˆè¨­å®š API Key"); window.toggleApiKeyInput(); return null; }
            return new GoogleGenerativeAI(apiKey).getGenerativeModel({ model: "gemini-1.5-flash" });
        }

        // AI æ’ç‰ˆ
        window.rewriteWithAI = async function() {
            const contentArea = document.getElementById('postContent');
            const originalText = contentArea.value;
            if (!originalText) { alert("è«‹å…ˆè¼¸å…¥å…§å®¹"); return; }
            
            const model = await getGeminiModel();
            if (!model) return;

            const btn = document.getElementById('aiRewriteBtn');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ†æä¸­...';
            btn.disabled = true;

            try {
                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­æ“ç›¤æ‰‹ã€Œå°æµ·ã€ã€‚è«‹å°‡ä»¥ä¸‹ç­†è¨˜æ ¹æ“šã€Œå°æµ·è§€å¯Ÿå®¤å®Œæ•´æ¡†æ¶ã€é‡æ–°æ’ç‰ˆã€‚
                ã€ç¦æ­¢ã€‘ï¼šMarkdownèªæ³• (#, **)ã€‚
                ã€æ ¼å¼ã€‘ï¼šç´”æ–‡å­—ï¼ŒEmoji (ğŸ”¥, âœ…, âš ï¸, ğŸ’°)ã€‚
                ã€æ¶æ§‹ã€‘ï¼š
                ã€å°æµ·è§€å¯Ÿå®¤ã€‘YYYY/MM/DD
                ## ğŸ¯ æ ¸å¿ƒæˆ°ç•¥ (å‰æ—¥ç¸½çµã€ä»Šæ—¥ä¸»è»¸)
                ä¸€ã€ğŸŒ å¸‚å ´æ•¸æ“š
                äºŒã€ğŸ“ˆ æŠ€è¡“é¢
                ä¸‰ã€ğŸ’° ç±Œç¢¼é¢
                å››ã€ğŸ”¥ ç”¢æ¥­é‡ç£…
                äº”ã€ğŸ’¡ æ“ä½œç­–ç•¥ (å«æ—©ç›¤5åˆ†Kåˆ¤æ–·)
                å…­ã€âš ï¸ é¢¨éšªæç¤º
                ä¸ƒã€ğŸ’¡ å°æµ·ç¸½çµ
                çµå°¾ï¼šğŸ“¢ æé†’ï¼šæœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒï¼Œé¢¨éšªè‡ªè²  Â© å°æµ·çš„åšå¤¢æ•…äº‹
                
                å…§å®¹ï¼š${originalText}`;
                
                const result = await model.generateContent(prompt);
                let text = result.response.text();
                text = text.replace(/#/g, '').replace(/\*\*/g, '').replace(/\*/g, 'ãƒ»');
                
                // Auto Title
                const titleMatch = text.match(/ã€å°æµ·.*?ã€‘.*?\n/);
                if (titleMatch) document.getElementById('postTitle').value = titleMatch[0].trim();
                
                contentArea.value = text;
            } catch (e) { alert("AI éŒ¯èª¤: " + e.message); }
            finally { btn.innerHTML = oldText; btn.disabled = false; }
        }

        // ç¤¾ç¾¤çŸ­æ–‡ç”Ÿæˆ
        window.generateSocialText = async function() {
            const content = document.getElementById('postContent').value;
            if (!content) { alert("è«‹å…ˆæœ‰æ–‡ç« å…§å®¹"); return; }
            
            const model = await getGeminiModel();
            if (!model) return;

            const btn = document.getElementById('textGenBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const result = await model.generateContent(`è«‹å°‡é€™ç¯‡æ–‡ç« æ¿ƒç¸®æˆä¸€æ®µ 100 å­—ä»¥å…§çš„ç¤¾ç¾¤è²¼æ–‡ (Line/IG)ã€‚
                é¢¨æ ¼ï¼šå°ˆæ¥­ã€å¸ç›ã€æœ‰æ€¥è¿«æ„Ÿã€‚
                çµå°¾åŠ ä¸Š Hashtag #å°æµ·è§€å¯Ÿå®¤ #å°è‚¡ã€‚
                æ–‡ç« ï¼š${content}`);
                
                const text = result.response.text();
                document.getElementById('modalBody').innerHTML = `
                    <h3 class="text-white font-bold mb-2">ğŸ“± ç¤¾ç¾¤çŸ­æ–‡</h3>
                    <textarea class="w-full bg-slate-900 text-white p-3 rounded h-48 border border-slate-600">${text}</textarea>
                    <button onclick="navigator.clipboard.writeText(this.previousElementSibling.value);alert('å·²è¤‡è£½')" class="w-full mt-2 bg-green-600 text-white py-2 rounded font-bold">è¤‡è£½æ–‡æ¡ˆ</button>
                `;
                document.getElementById('modalOverlay').style.display = "block";
            } catch (e) { alert("ç”Ÿæˆå¤±æ•—: " + e.message); }
            finally { btn.innerHTML = '<i class="fab fa-line"></i> ç”ŸæˆçŸ­æ–‡'; }
        }

        // é»‘å¡ç”Ÿæˆ (Black Background)
        window.generateSocialImage = async function() {
            const content = document.getElementById('postContent').value;
            const title = document.getElementById('postTitle').value || "å°æµ·è§€å¯Ÿå®¤";
            if (!content) { alert("è«‹å…ˆæœ‰å…§å®¹"); return; }

            const model = await getGeminiModel();
            if (!model) return;

            const btn = document.getElementById('imgGenBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // 1. AI æ‘˜è¦
                const result = await model.generateContent(`è«‹å¾æ–‡ç« æç…‰ 3 é»çµè«–(æ¯é»15å­—å…§)ï¼Œä¾›åœ–å¡ä½¿ç”¨ã€‚ä¸éœ€è¦æ¨™é¡Œï¼Œç›´æ¥åˆ—é»ã€‚æ–‡ç« ï¼š${content}`);
                const summary = result.response.text();
                const lines = summary.split('\n').filter(l => l.trim().length > 0).slice(0, 3);

                // 2. Canvas ç¹ªåœ– (é»‘è‰²èƒŒæ™¯)
                const canvas = document.createElement('canvas');
                canvas.width = 1080; canvas.height = 1080;
                const ctx = canvas.getContext('2d');

                // èƒŒæ™¯ï¼šç´”é»‘è³ªæ„Ÿæ¼¸å±¤
                const gradient = ctx.createLinearGradient(0, 0, 1080, 1080);
                gradient.addColorStop(0, '#1a1a1a');   // æ·±ç°
                gradient.addColorStop(1, '#000000');   // ç´”é»‘
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1080, 1080);

                // è£é£¾ï¼šé‡‘è‰²ç·šæ¢
                ctx.strokeStyle = '#d4af37'; // Gold
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(50, 50); ctx.lineTo(1030, 50);
                ctx.lineTo(1030, 1030); ctx.lineTo(50, 1030); ctx.closePath();
                ctx.stroke();

                // æ¨™é¡Œ (é‡‘è‰²)
                ctx.fillStyle = '#facc15'; 
                ctx.font = 'bold 80px "Microsoft JhengHei", sans-serif';
                ctx.textAlign = 'center';
                const cleanTitle = title.replace(/ã€.*?ã€‘/, '').trim().substring(0, 12);
                ctx.fillText(cleanTitle, 540, 200);

                // å°æµ· Logo
                ctx.fillStyle = '#60a5fa'; 
                ctx.font = 'bold 40px "Microsoft JhengHei", sans-serif';
                ctx.fillText("ã€å°æµ·è§€å¯Ÿå®¤ã€‘", 540, 100);

                // åˆ†éš”ç·š
                ctx.strokeStyle = '#333';
                ctx.beginPath(); ctx.moveTo(140, 280); ctx.lineTo(940, 280); ctx.stroke();

                // é‡é»å…§å®¹ (ç™½è‰²)
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 50px "Microsoft JhengHei", sans-serif';
                ctx.textAlign = 'left';
                let startY = 400;
                lines.forEach(line => {
                    // å»é™¤ markdown ç¬¦è™Ÿ
                    const cleanLine = line.replace(/\*/g, '').replace(/-/g, '').trim();
                    ctx.fillText('ğŸ”¥ ' + cleanLine, 100, startY);
                    startY += 120;
                });

                // åº•éƒ¨ç‰ˆæ¬Š
                ctx.fillStyle = '#64748b';
                ctx.font = '30px "Microsoft JhengHei", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText("Â© å°æµ·çš„åšå¤¢æ•…äº‹ | æŠ•è³‡é¢¨éšªè‡ªè² ", 540, 1000);

                // é¡¯ç¤º
                const dataUrl = canvas.toDataURL('image/png');
                document.getElementById('modalBody').innerHTML = `
                    <h3 class="text-white font-bold mb-2">âœ¨ é»‘è‰²ç³»åœ–å¡</h3>
                    <img src="${dataUrl}" class="w-full rounded shadow-lg border border-slate-700">
                    <a href="${dataUrl}" download="å°æµ·è§€å¯Ÿå®¤_${new Date().toISOString().slice(0,10)}.png" class="block w-full bg-blue-600 text-white font-bold py-3 rounded mt-4 text-center hover:bg-blue-500">ä¸‹è¼‰åœ–ç‰‡</a>
                `;
                document.getElementById('modalOverlay').style.display = "block";

            } catch (e) { alert("ç”Ÿæˆå¤±æ•—: " + e.message); }
            finally { btn.innerHTML = '<i class="fas fa-image"></i> ç”Ÿæˆé»‘å¡'; }
        }

        // UI Helpers
        window.closeModal = function() { document.getElementById('modalOverlay').style.display = "none"; }
        window.insertImagePrompt = function() {
            const url = prompt("è«‹è¼¸å…¥åœ–ç‰‡ç¶²å€ (URL):");
            if (url) {
                const md = `\n[Image of Chart](${url})\n`; // é›–ç„¶ç¦æ­¢MDä½†åœ–ç‰‡é€šå¸¸éœ€è¦ï¼Œæˆ–ç›´æ¥ç”¨ HTML
                const htmlImg = `\n<img src="${url}" alt="åœ–è¡¨" style="width:100%; border-radius:8px; margin: 10px 0;">\n`;
                document.getElementById('postContent').value += htmlImg;
            }
        }
        window.copyCalcResult = function() {
            // ç°¡å–®è¤‡è£½ç´”æ–‡å­—
            const text = document.getElementById('calcResult').innerText;
            navigator.clipboard.writeText(text).then(() => alert('é»ä½å·²è¤‡è£½'));
        }

        window.submitPost = async function() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const category = document.querySelector('input[name="category"]:checked').value;
            const btn = document.getElementById('submitBtn');

            if (!title || !content) { alert("æ¨™é¡Œå’Œå…§å®¹ä¸èƒ½ç‚ºç©º"); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™¼é€ä¸­...';

            try {
                await addDoc(collection(db, "posts"), {
                    title, content, category, author: "å°æµ·", timestamp: serverTimestamp()
                });
                alert("ç™¼å¸ƒæˆåŠŸï¼");
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
            } catch (e) { alert("å¤±æ•—ï¼š" + e.message); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> ç™¼å¸ƒæˆ°å ±'; }
        }
    </script>

    <script>
        const ADMIN_PASSWORD = "0712"; 
        function checkLogin() {
            const pwd = document.getElementById('passwordInput').value;
            if (pwd === ADMIN_PASSWORD) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'flex';
                localStorage.setItem('littlesea_admin', 'true');
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
                document.getElementById('passwordInput').value = '';
            }
        }
        function logout() { localStorage.removeItem('littlesea_admin'); location.reload(); }
        if (localStorage.getItem('littlesea_admin') === 'true') {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'flex';
        }
    </script>
</body>
</html>