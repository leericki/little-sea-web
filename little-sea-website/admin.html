<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æµ·æ§åˆ¶å° | ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; }
        .preview-box { font-family: 'Noto Sans TC', sans-serif; line-height: 1.8; color: #334155; font-size: 15px; }
        .preview-box strong, .preview-box b { color: #0369a1; background-color: #f0f9ff; padding: 0 4px; border-radius: 4px; font-weight: 700; }
        .preview-box h1, .preview-box h2, .preview-box h3 { margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; color: #1e293b; }
        .preview-box ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .preview-box p { margin-bottom: 1em; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="loginSection" class="min-h-screen flex items-center justify-center absolute inset-0 z-50 bg-gray-100">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border text-center">
            <h2 class="text-2xl font-bold mb-8 text-gray-800">ç®¡ç†å“¡ç™»å…¥</h2>
            <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full px-4 py-3 rounded-lg border text-center mb-4 text-lg focus:ring-2 focus:ring-sky-500 outline-none">
            <button id="loginBtn" class="w-full bg-sky-600 text-white font-bold py-3 rounded-lg hover:bg-sky-700 transition shadow-lg">é©—è­‰èº«åˆ†</button>
            <p class="text-xs text-gray-400 mt-4">Authorized Personnel Only</p>
        </div>
    </div>

    <div id="dashboardSection" class="h-full hidden flex-col">
        <nav class="bg-white border-b px-6 py-3 flex justify-between items-center z-40 shadow-sm">
            <div class="flex items-center gap-4">
                <h1 class="font-bold text-gray-800 text-lg"><i class="fas fa-ship text-sky-600 mr-2"></i>å°æµ·ç™¼æ–‡ç³»çµ±</h1>
                <div class="flex gap-4 ml-6 text-sm">
                    <button id="tabPostBtn" class="font-bold pb-1 border-b-2 border-sky-500 text-sky-600">æ–‡ç« ç®¡ç†</button>
                    <button id="tabVipBtn" class="font-bold pb-1 text-gray-400 hover:text-gray-600 transition">å­¸å“¡ç®¡ç†</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="index.html" class="text-gray-600 bg-gray-50 border px-3 py-2 rounded-lg text-sm font-bold transition hover:bg-gray-100">ğŸ  å›é¦–é </a>
                <button id="aiConfigBtn" class="text-sky-600 bg-sky-50 border border-sky-100 px-3 py-2 rounded-lg text-sm font-bold hover:bg-sky-100 transition">
                    <i class="fas fa-robot mr-1"></i> AI è¨­å®š
                </button>
                <button id="logoutBtn" class="text-red-500 font-bold px-3 py-2 rounded-lg hover:bg-red-50 transition">ç™»å‡º</button>
            </div>
        </nav>

        <main id="postView" class="flex-1 flex overflow-hidden flex-col md:flex-row">
            <div class="w-72 bg-slate-50 border-r flex flex-col hidden md:flex">
                <div class="p-3 border-b font-bold text-gray-600 text-sm flex justify-between items-center">
                    <span>æ–‡ç« åˆ—è¡¨</span>
                    <span id="postCount" class="bg-gray-200 px-2 rounded-full text-xs py-0.5">0</span>
                </div>
                <div id="postListContainer" class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div class="text-center text-gray-400 text-sm mt-4"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <div class="flex-1 flex flex-col border-r bg-white overflow-y-auto p-6 space-y-5 relative">
                <div class="flex justify-between items-end">
                    <label class="text-sm font-bold text-gray-700">æ–‡ç« æ¨™é¡Œ</label>
                    <button id="aiTitleBtn" class="text-sky-600 text-xs font-bold bg-sky-50 px-2 py-1 rounded border hover:bg-sky-100 transition">âœ¨ AI è‡ªå‹•æ¨™é¡Œ</button>
                </div>
                <input type="text" id="postTitle" class="w-full px-4 py-2 rounded-lg border shadow-sm outline-none focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition" placeholder="è¼¸å…¥æ¨™é¡Œ...">
                
                <label class="text-sm font-bold text-gray-700">æ–‡ç« åˆ†é¡</label>
                <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                    <label class="cursor-pointer"><input type="radio" name="category" value="ç›¤å‰åˆ†æ" class="peer sr-only" checked><div class="text-center py-2 text-sm border rounded-md peer-checked:bg-blue-600 peer-checked:text-white transition hover:bg-gray-50">ç›¤å‰</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="ç›¤ä¸­åˆ†æ" class="peer sr-only"><div class="text-center py-2 text-sm border-2 border-red-100 rounded-md peer-checked:bg-red-600 peer-checked:text-white font-bold text-red-600 transition hover:bg-red-50">ğŸ”¥ ç›¤ä¸­</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="ç‰¹è¨“å€" class="peer sr-only"><div class="text-center py-2 text-sm border-2 border-emerald-100 rounded-md peer-checked:bg-emerald-600 peer-checked:text-white font-bold text-emerald-600 transition hover:bg-emerald-50">ğŸŸ¢ ç‰¹è¨“</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="ç›¤å¾Œåˆ†æ" class="peer sr-only"><div class="text-center py-2 text-sm border rounded-md peer-checked:bg-indigo-600 peer-checked:text-white transition hover:bg-gray-50">ç›¤å¾Œ</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="å‘¨æœ«åˆ†æ" class="peer sr-only"><div class="text-center py-2 text-sm border rounded-md peer-checked:bg-purple-600 peer-checked:text-white transition hover:bg-gray-50">å‘¨æœ«</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="å¿ƒæ…‹åˆ†äº«" class="peer sr-only"><div class="text-center py-2 text-sm border rounded-md peer-checked:bg-amber-500 peer-checked:text-white transition hover:bg-gray-50">å¿ƒæ…‹</div></label>
                </div>

                <div class="flex justify-between items-end mb-1">
                    <label class="text-sm font-bold text-gray-700">å…§å®¹ç·¨è¼¯ (Markdown)</label>
                    
                    <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 p-1 rounded-lg">
                        <select id="aiEngineSelect" class="text-xs font-bold text-gray-700 bg-transparent border-none outline-none cursor-pointer pr-1">
                            <option value="perplexity">ğŸŒŠ Perplexity (æµ·ç´)</option>
                            <option value="gemini">â™Š Google Gemini (æ–‡ç­†)</option>
                        </select>
                        <button onclick="document.getElementById('aiConfigModal').classList.remove('hidden')" class="text-gray-400 hover:text-blue-600 transition p-1" title="è¨­å®š API Key">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="aiRewriteBtn" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white text-xs font-bold py-1.5 px-3 rounded-full shadow hover:shadow-md transition transform active:scale-95 ml-1">
                            å‘¼å«æ’ç‰ˆ
                        </button>
                    </div>
                </div>
                <textarea id="postContent" rows="12" class="w-full px-4 py-3 rounded-lg border font-mono text-sm leading-relaxed focus:ring-2 focus:ring-sky-200 outline-none resize-none" placeholder="åœ¨æ­¤è¼¸å…¥è‰ç¨¿..." oninput="window.updatePreview()"></textarea>
                
                <button id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-700 transition transform active:scale-[0.99] flex justify-center items-center gap-2">
                    <i class="fas fa-paper-plane"></i> ç¢ºèªç™¼å¸ƒæ–‡ç« 
                </button>
            </div>

            <div class="hidden md:flex flex-1 flex-col bg-slate-50 overflow-y-auto">
                <div class="p-3 bg-white border-b font-bold text-gray-500 text-sm">å³æ™‚é è¦½</div>
                <div class="p-6">
                    <div class="bg-white rounded-xl shadow-sm p-8 max-w-lg mx-auto min-h-[500px]">
                        <h2 id="previewTitle" class="text-2xl font-bold mb-6 border-b-2 pb-4 text-slate-800">æ–‡ç« æ¨™é¡Œ...</h2>
                        <div id="previewContent" class="preview-box text-gray-400 italic">
                            é è¦½å…§å®¹å°‡é¡¯ç¤ºæ–¼æ­¤...
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <main id="vipView" class="flex-1 hidden p-8 overflow-y-auto bg-gray-50">
            <div class="max-w-2xl mx-auto bg-white rounded-2xl p-8 border shadow-sm">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fas fa-user-plus text-emerald-500"></i> æ–°å¢å­¸å“¡ Email</h3>
                <div class="flex gap-4 mb-8">
                    <input type="email" id="vipEmailInput" placeholder="user@gmail.com" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-200 outline-none">
                    <button id="addVipBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 rounded-lg font-bold transition shadow">æ–°å¢</button>
                </div>
                <h3 class="text-lg font-bold mb-4 border-b pb-2 flex justify-between items-center">
                    å­¸å“¡åå–®
                    <span id="vipCount" class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs">0</span>
                </h3>
                <div id="vipListTable" class="divide-y border rounded-xl overflow-hidden shadow-sm max-h-[500px] overflow-y-auto bg-white">
                    <div class="p-4 text-center text-gray-400">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </main>
    </div>

    <div id="aiConfigModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border border-gray-200 animate-fade-in-up">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg flex items-center gap-2"><i class="fas fa-robot"></i> AI å¼•æ“ä¸­æ§å°</h3>
                <button onclick="document.getElementById('aiConfigModal').classList.add('hidden')" class="text-slate-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 text-sm text-blue-700 mb-2">
                    <i class="fas fa-info-circle mr-1"></i> è¨­å®šå°‡å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œå®‰å…¨æ–¹ä¾¿ã€‚
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ğŸŒŠ Perplexity API Key</label>
                    <input type="password" id="inputPerplexityKey" placeholder="pplx-..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-mono">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">â™Š Google Gemini API Key</label>
                    <input type="password" id="inputGeminiKey" placeholder="AIzaSy..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-mono">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t">
                <button onclick="document.getElementById('aiConfigModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold text-sm hover:text-gray-700">å–æ¶ˆ</button>
                <button id="saveKeysBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md transition"><i class="fas fa-save mr-1"></i> å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <script type="module">
        // -------------------------------------------------------------------
        // 1. è¨­å®šå€åŸŸ (å·²æ•´åˆ Config)
        // -------------------------------------------------------------------
        
        const ADMIN_PASS = "888888"; // è¨­å®šä½ çš„ç®¡ç†å“¡ç™»å…¥å¯†ç¢¼
        const DEFAULT_G_KEY = "";    // é è¨­ Gemini Key (é¸å¡«)
        const PERPLEXITY_KEY = "";   // é è¨­ Perplexity Key (é¸å¡«)

        // â–¼â–¼â–¼ ã€é—œéµä¿®æ­£ã€‘æˆ‘å·²å°‡ Project ID å¼·åˆ¶æ”¹ç‚º seawebfire â–¼â–¼â–¼
        // å¦‚æœé€™å€‹ API Key çœŸçš„ä¸èƒ½ç”¨ï¼Œè«‹ä½ å» seawebfire å°ˆæ¡ˆè¨­å®šè¤‡è£½æ–°çš„ apiKey è²¼éä¾†
        const firebaseConfig = {
            apiKey: "AIzaSyBi7FXRLt9qiVNa-qipPo-OD-b_qseQHUQ", 
            authDomain: "seawebfire.firebaseapp.com",        // æ”¹ç‚º seawebfire
            projectId: "seawebfire",                         // æ”¹ç‚º seawebfire (å°æ‡‰ä½ çš„è³‡æ–™åº«)
            storageBucket: "seawebfire.firebasestorage.app", // æ”¹ç‚º seawebfire
            messagingSenderId: "561243064522",
            appId: "1:561243064522:web:cdfffd357c9af417b08c33",
            measurementId: "G-D93F1E1GR3"
        };

        // 2. å¼•å…¥ Firebase SDK (CDN ç‰ˆæœ¬)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        let app, db, auth;
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginBtn = document.getElementById('loginBtn');
        const passwordInput = document.getElementById('passwordInput');

        // --- Firebase åˆå§‹åŒ– ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("âœ… Firebase é€£ç·šæˆåŠŸ (Project ID: " + firebaseConfig.projectId + ")");
        } catch (error) {
            console.error("âŒ Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            alert("ç³»çµ±éŒ¯èª¤ï¼šè³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Config è¨­å®šã€‚");
        }

        // --- ç™»å…¥é‚è¼¯ ---
        function handleLogin() {
            const inputVal = passwordInput.value;
            if (inputVal.trim() === ADMIN_PASS) {
                console.log("ğŸ” å¯†ç¢¼æ­£ç¢º");
                localStorage.setItem('littlesea_admin', 'true');
                initDashboard();
            } else {
                alert("âŒ å¯†ç¢¼éŒ¯èª¤");
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // --- é€²å…¥å„€è¡¨æ¿ ---
        function initDashboard() {
            loginSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            dashboardSection.classList.add('flex');

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("ğŸ‘¤ ç®¡ç†å“¡ UID:", user.uid);
                    startDataListeners();
                    updateMenuStatus();
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Auth Error:", error);
                        alert("æ¬Šé™é©—è­‰å¤±æ•—: " + error.message);
                    });
                }
            });
        }

        // --- è³‡æ–™ç›£è½ (Realtime) ---
        function startDataListeners() {
            // ç›£è½æ–‡ç«  (ä½¿ç”¨ posts é›†åˆ)
            const qPost = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            onSnapshot(qPost, (snapshot) => {
                const list = document.getElementById('postListContainer');
                if(document.getElementById('postCount')) document.getElementById('postCount').innerText = snapshot.docs.length;
                list.innerHTML = '';
                snapshot.forEach((docSnap) => {
                    const post = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'bg-white p-3 rounded shadow-sm border mb-2 relative group hover:shadow-md transition cursor-pointer hover:border-sky-300';
                    item.innerHTML = `
                        <div class="font-bold text-gray-700 line-clamp-1">${post.title || 'ç„¡æ¨™é¡Œ'}</div>
                        <div class="text-xs text-gray-400 mt-1 flex justify-between items-center">
                            <span class="bg-gray-100 px-1.5 rounded">${post.category}</span>
                            <span>${post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleDateString() : 'å‰›å‰›'}</span>
                        </div>
                        <button onclick="event.stopPropagation(); window.delPost('${docSnap.id}')" class="absolute top-3 right-3 text-red-300 hover:text-red-600 transition opacity-0 group-hover:opacity-100 p-1" title="åˆªé™¤æ–‡ç« ">
                            <i class="fas fa-trash-alt"></i>
                        </button>`;
                    
                    item.addEventListener('click', () => {
                        document.getElementById('postTitle').value = post.title || '';
                        document.getElementById('postContent').value = post.content || '';
                        const radios = document.querySelectorAll('input[name="category"]');
                        radios.forEach(r => { if(r.value === post.category) r.checked = true; });
                        window.updatePreview();
                    });
                    list.appendChild(item);
                });
            }, (error) => {
                console.error("è®€å–æ–‡ç« éŒ¯èª¤:", error);
                if(error.message.includes("permission-denied")) alert("è®€å–å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥ Firebase Rules æ˜¯å¦é–‹å•Ÿ Test Modeã€‚");
            });

            // ç›£è½ VIP
            onSnapshot(collection(db, "vip_members"), (snapshot) => {
                const list = document.getElementById('vipListTable');
                if(document.getElementById('vipCount')) document.getElementById('vipCount').innerText = snapshot.docs.length;
                list.innerHTML = '';
                snapshot.forEach((docSnap) => {
                    const vip = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'flex justify-between p-4 bg-white items-center hover:bg-slate-50 transition border-b last:border-0';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold text-xs"><i class="fas fa-user"></i></div>
                            <span class="font-mono text-gray-700 text-sm">${vip.email}</span>
                        </div>
                        <button onclick="window.delVip('${docSnap.id}')" class="text-red-400 hover:text-red-600 font-bold text-xs border border-red-200 hover:border-red-400 px-2 py-1 rounded transition">
                            ç§»å‡º
                        </button>`;
                    list.appendChild(div);
                });
            });
        }

        // --- å…¨åŸŸåŠŸèƒ½ ---
        window.delPost = async (id) => {
            if (confirm("âš ï¸ ç¢ºå®šåˆªé™¤æ­¤æ–‡ç« ï¼Ÿ")) {
                try { await deleteDoc(doc(db, "posts", id)); } 
                catch(e) { alert("åˆªé™¤å¤±æ•—: " + e.message); }
            }
        };

        window.delVip = async (id) => {
            if (confirm("ç¢ºå®šç§»é™¤æ­¤ VIPï¼Ÿ")) {
                try { await deleteDoc(doc(db, "vip_members", id)); }
                catch(e) { alert("ç§»é™¤å¤±æ•—: " + e.message); }
            }
        };

        window.updatePreview = () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            document.getElementById('previewTitle').innerText = title || "æ–‡ç« æ¨™é¡Œ...";
            document.getElementById('previewContent').innerHTML = content ? marked.parse(content) : '<span class="text-gray-400 italic">é è¦½å…§å®¹å°‡é¡¯ç¤ºæ–¼æ­¤...</span>';
        };

        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if(confirm("ç¢ºå®šç™»å‡ºç³»çµ±ï¼Ÿ")) {
                localStorage.removeItem('littlesea_admin');
                location.reload();
            }
        });

        document.getElementById('tabPostBtn').addEventListener('click', () => switchTab('post'));
        document.getElementById('tabVipBtn').addEventListener('click', () => switchTab('vip'));

        function switchTab(target) {
            const postV = document.getElementById('postView');
            const vipV = document.getElementById('vipView');
            const tP = document.getElementById('tabPostBtn');
            const tV = document.getElementById('tabVipBtn');
            
            if (target === 'post') {
                postV.classList.remove('hidden'); postV.classList.add('flex'); vipV.classList.add('hidden');
                tP.className = 'font-bold pb-1 border-b-2 border-sky-500 text-sky-600 transition';
                tV.className = 'font-bold pb-1 text-gray-400 hover:text-gray-600 transition';
            } else {
                postV.classList.add('hidden'); postV.classList.remove('flex'); vipV.classList.remove('hidden');
                tV.className = 'font-bold pb-1 border-b-2 border-sky-500 text-sky-600 transition';
                tP.className = 'font-bold pb-1 text-gray-400 hover:text-gray-600 transition';
            }
        }

        document.getElementById('addVipBtn').addEventListener('click', async () => {
            const input = document.getElementById('vipEmailInput');
            const email = input.value.trim().toLowerCase();
            if(!email) return alert("è«‹è¼¸å…¥ Email");
            try {
                const btn = document.getElementById('addVipBtn');
                btn.disabled = true; btn.innerText = "...";
                await addDoc(collection(db, "vip_members"), { email, addedAt: serverTimestamp() });
                input.value = '';
                alert("âœ… å·²æ–°å¢ VIP");
            } catch(e) { alert("æ–°å¢å¤±æ•—: " + e.message); }
            finally { document.getElementById('addVipBtn').disabled = false; document.getElementById('addVipBtn').innerText = "æ–°å¢"; }
        });

        // ç™¼å¸ƒæ–‡ç« 
        document.getElementById('submitBtn').addEventListener('click', async () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const category = document.querySelector('input[name="category"]:checked')?.value || "ä¸€èˆ¬";

            if (!title || !content) return alert("âŒ æ¨™é¡Œèˆ‡å…§å®¹ä¸èƒ½ç‚ºç©º");

            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™¼å¸ƒä¸­...';

            try {
                await addDoc(collection(db, "posts"), {
                    title, content, category,
                    author: "å°æµ·",
                    timestamp: serverTimestamp()
                });
                alert("âœ… æ–‡ç« ç™¼å¸ƒæˆåŠŸï¼");
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
                window.updatePreview();
            } catch (e) {
                console.error("ç™¼å¸ƒå¤±æ•—:", e);
                if(e.message.includes("not-found")) {
                    alert("ç™¼å¸ƒå¤±æ•—ï¼šæ‰¾ä¸åˆ°è³‡æ–™åº«ã€‚\nè«‹å» Firebase å¾Œå°è¤‡è£½ seawebfire çš„æ­£ç¢º API Key è²¼åˆ°ç¨‹å¼ç¢¼ä¸­ã€‚");
                } else if(e.message.includes("permission-denied")) {
                    alert("ç™¼å¸ƒå¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚è«‹å» Firebase Console é–‹å•Ÿ Test Modeã€‚");
                } else {
                    alert("ç™¼å¸ƒå¤±æ•—: " + e.message);
                }
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> ç¢ºèªç™¼å¸ƒæ–‡ç« ';
            }
        });

        // --- AI åŠŸèƒ½ ---
        const aiModal = document.getElementById('aiConfigModal');
        const selectMenu = document.getElementById('aiEngineSelect');
        
        function updateMenuStatus() {
            const pKey = localStorage.getItem('user_perplexity_key');
            const gKey = localStorage.getItem('user_gemini_key');
            
            if(selectMenu.options.length > 0) {
                selectMenu.options[0].text = (pKey && pKey.length > 10) ? "âœ… Perplexity (æµ·ç´)" : "âŒ Perplexity (æœªè¨­å®š)";
                selectMenu.options[1].text = (gKey && gKey.length > 10) ? "âœ… Google Gemini (æ–‡ç­†)" : "âŒ Google Gemini (æœªè¨­å®š)";
            }
        }

        document.getElementById('aiConfigBtn').addEventListener('click', () => {
            document.getElementById('inputPerplexityKey').value = localStorage.getItem('user_perplexity_key') || "";
            document.getElementById('inputGeminiKey').value = localStorage.getItem('user_gemini_key') || "";
            aiModal.classList.remove('hidden');
        });

        document.getElementById('saveKeysBtn').addEventListener('click', () => {
            const pKey = document.getElementById('inputPerplexityKey').value.trim();
            const gKey = document.getElementById('inputGeminiKey').value.trim();
            if(pKey) localStorage.setItem('user_perplexity_key', pKey);
            if(gKey) localStorage.setItem('user_gemini_key', gKey);
            alert("âœ… é‡‘é‘°è¨­å®šå·²å„²å­˜");
            aiModal.classList.add('hidden');
            updateMenuStatus();
        });

        // AI å‘¼å«é€šç”¨å‡½å¼
        async function callAI(prompt, systemMsg) {
            const engine = selectMenu.value;
            const pKey = localStorage.getItem('user_perplexity_key');
            const gKey = localStorage.getItem('user_gemini_key');

            if (engine === 'perplexity' && (!pKey || pKey.length < 10)) throw new Error("è«‹å…ˆè¨­å®š Perplexity Key");
            if (engine === 'gemini' && (!gKey || gKey.length < 10)) throw new Error("è«‹å…ˆè¨­å®š Google Gemini Key");

            if (engine === 'perplexity') {
                const res = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${pKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'sonar-pro',
                        messages: [{ role: 'system', content: systemMsg }, { role: 'user', content: prompt }],
                        temperature: 0.2
                    })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                return data.choices[0].message.content;
            } else {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${gKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemMsg + "\n" + prompt }] }] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            }
        }

        // AI æ’ç‰ˆ
        document.getElementById('aiRewriteBtn').addEventListener('click', async () => {
            const content = document.getElementById('postContent').value;
            const category = document.querySelector('input[name="category"]:checked')?.value || "ä¸€èˆ¬";
            if (!content) return alert("è«‹å…ˆè¼¸å…¥ä¸€äº›è‰ç¨¿å…§å®¹...");

            const btn = document.getElementById('aiRewriteBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';

            try {
                const result = await callAI(content, `ä½ ç¾åœ¨æ˜¯ã€Œå°æµ·è²¡ç¶“ã€ç¸½ç·¨è¼¯ã€‚è«‹å°‡å…§å®¹é‡å¯«ç‚ºã€å°æµ·${category}è§€å¯Ÿå®¤ã€‘é¢¨æ ¼ã€‚è¦æ±‚ï¼šå°ˆæ¥­ã€æ¢ç†åˆ†æ˜ã€ä½¿ç”¨ Markdownã€‚`);
                document.getElementById('postContent').value = result.replace(/```markdown/g, '').replace(/```/g, '');
                window.updatePreview();
            } catch (e) { alert(`âŒ AI éŒ¯èª¤ï¼š${e.message}`); } 
            finally { btn.disabled = false; btn.innerHTML = originalText; }
        });

        // AI è‡ªå‹•æ¨™é¡Œ
        document.getElementById('aiTitleBtn').addEventListener('click', async () => {
            const content = document.getElementById('postContent').value;
            if (!content) return alert("ğŸ’¡ è«‹å…ˆå®Œæˆå…§æ–‡ï¼ŒAI æ‰èƒ½å¹«ä½ æ‘˜è¦æ¨™é¡Œ");

            const btn = document.getElementById('aiTitleBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'âœ¨ ç”Ÿæˆä¸­...';

            try {
                let result = await callAI(content, "è«‹æ ¹æ“šä»¥ä¸‹æ–‡ç« å…§å®¹ï¼Œç”Ÿæˆä¸€å€‹å¸å¼•äººã€å°ˆæ¥­çš„è²¡ç¶“æ–‡ç« æ¨™é¡Œã€‚åªè¦å›å‚³æ¨™é¡Œæœ¬èº«ï¼Œä¸è¦å¼•è™Ÿï¼Œä¸è¦å¤šé¤˜çš„å­—ã€‚");
                result = result.replace(/"/g, '').replace(/æ¨™é¡Œï¼š/g, '').trim();
                document.getElementById('postTitle').value = result;
                window.updatePreview();
            } catch (e) { 
                alert(`âŒ ç”Ÿæˆå¤±æ•—ï¼š${e.message}`); 
            } finally { 
                btn.disabled = false; btn.innerHTML = originalText; 
            }
        });

        if (localStorage.getItem('littlesea_admin') === 'true') {
            initDashboard();
        }

    </script>
</body>
</html>