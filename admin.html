<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æµ·æ§åˆ¶å° | ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; }
        .preview-box { font-family: 'Noto Sans TC', sans-serif; line-height: 1.8; color: #334155; font-size: 15px; }
        .preview-box strong, .preview-box b { color: #0369a1; background-color: #f0f9ff; padding: 0 4px; border-radius: 4px; font-weight: 700; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="loginSection" class="min-h-screen flex items-center justify-center absolute inset-0 z-50 bg-gray-100">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border text-center">
            <h2 class="text-2xl font-bold mb-8 text-gray-800">ç®¡ç†å“¡ç™»å…¥</h2>
            <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full px-4 py-3 rounded-lg border text-center mb-4 text-lg">
            <button id="loginBtn" class="w-full bg-sky-600 text-white font-bold py-3 rounded-lg hover:bg-sky-700 transition">é©—è­‰èº«åˆ†</button>
        </div>
    </div>

    <div id="dashboardSection" class="h-full hidden flex-col">
        <nav class="bg-white border-b px-6 py-3 flex justify-between items-center z-40 shadow-sm">
            <div class="flex items-center gap-4">
                <h1 class="font-bold text-gray-800 text-lg"><i class="fas fa-ship text-sky-600 mr-2"></i>å°æµ·ç™¼æ–‡ç³»çµ±</h1>
                <div class="flex gap-4 ml-6 text-sm">
                    <button id="tabPostBtn" class="font-bold pb-1 border-b-2 border-sky-500 text-sky-600">æ–‡ç« ç®¡ç†</button>
                    <button id="tabVipBtn" class="font-bold pb-1 text-gray-400 hover:text-gray-600 transition">å­¸å“¡ç®¡ç†</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="index.html" class="text-gray-600 bg-gray-50 border px-3 py-2 rounded-lg text-sm font-bold transition hover:bg-gray-100">ğŸ  å›é¦–é </a>
                <button id="aiConfigBtn" class="text-sky-600 bg-sky-50 border border-sky-100 px-3 py-2 rounded-lg text-sm font-bold hover:bg-sky-100 transition">
                    <i class="fas fa-robot mr-1"></i> AI è¨­å®š
                </button>
                <button id="logoutBtn" class="text-red-500 font-bold px-3 py-2 rounded-lg hover:bg-red-50 transition">ç™»å‡º</button>
            </div>
        </nav>

        <main id="postView" class="flex-1 flex overflow-hidden flex-col md:flex-row">
            <div class="w-72 bg-slate-50 border-r flex flex-col hidden md:flex">
                <div class="p-3 border-b font-bold text-gray-600 text-sm flex justify-between">
                    <span>æ–‡ç« åˆ—è¡¨</span>
                    <span id="postCount" class="bg-gray-200 px-2 rounded-full text-xs flex items-center">0</span>
                </div>
                <div id="postListContainer" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
            </div>

            <div class="flex-1 flex flex-col border-r bg-white overflow-y-auto p-6 space-y-5 relative">
                <div class="flex justify-between items-end">
                    <label class="text-sm font-bold text-gray-700">æ–‡ç« æ¨™é¡Œ</label>
                    <button id="aiTitleBtn" class="text-sky-600 text-xs font-bold bg-sky-50 px-2 py-1 rounded border hover:bg-sky-100 transition">âœ¨ AI è‡ªå‹•æ¨™é¡Œ</button>
                </div>
                <input type="text" id="postTitle" class="w-full px-4 py-2 rounded-lg border shadow-sm outline-none focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition" placeholder="è¼¸å…¥æ¨™é¡Œ...">
                
                <label class="text-sm font-bold text-gray-700">æ–‡ç« åˆ†é¡</label>
                <div class="grid grid-cols-3 gap-2">
                    <label class="cursor-pointer"><input type="radio" name="category" value="ç›¤å‰åˆ†æ" class="peer sr-only" checked><div class="text-center py-2 text-sm border rounded-md peer-checked:bg-blue-600 peer-checked:text-white transition">ç›¤å‰</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="ç›¤ä¸­åˆ†æ" class="peer sr-only"><div class="text-center py-2 text-sm border-2 border-red-100 rounded-md peer-checked:bg-red-600 peer-checked:text-white font-bold text-red-600 transition">ğŸ”¥ ç›¤ä¸­</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="ç‰¹è¨“å€" class="peer sr-only"><div class="text-center py-2 text-sm border-2 border-emerald-100 rounded-md peer-checked:bg-emerald-600 peer-checked:text-white font-bold text-emerald-600 transition">ğŸŸ¢ ç‰¹è¨“</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="ç›¤å¾Œåˆ†æ" class="peer sr-only"><div class="text-center py-2 text-sm border rounded-md peer-checked:bg-indigo-600 peer-checked:text-white transition">ç›¤å¾Œ</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="å‘¨æœ«åˆ†æ" class="peer sr-only"><div class="text-center py-2 text-sm border rounded-md peer-checked:bg-purple-600 peer-checked:text-white transition">å‘¨æœ«</div></label>
                    <label class="cursor-pointer"><input type="radio" name="category" value="å¿ƒæ…‹åˆ†äº«" class="peer sr-only"><div class="text-center py-2 text-sm border rounded-md peer-checked:bg-amber-500 peer-checked:text-white transition">å¿ƒæ…‹</div></label>
                </div>

                <div class="flex justify-between items-end mb-1">
                    <label class="text-sm font-bold text-gray-700">å…§å®¹ç·¨è¼¯</label>
                    
                    <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 p-1 rounded-lg">
                        <select id="aiEngineSelect" class="text-xs font-bold text-gray-700 bg-transparent border-none outline-none cursor-pointer pr-1">
                            <option value="perplexity">ğŸŒŠ Perplexity (æµ·ç´)</option>
                            <option value="gemini">â™Š Google Gemini (æ–‡ç­†)</option>
                        </select>
                        <button onclick="document.getElementById('aiConfigModal').classList.remove('hidden')" class="text-gray-400 hover:text-blue-600 transition p-1" title="è¨­å®š API Key">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="aiRewriteBtn" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white text-xs font-bold py-1.5 px-3 rounded-full shadow hover:shadow-md transition transform active:scale-95 ml-1">
                            å‘¼å«æ’ç‰ˆ
                        </button>
                    </div>
                </div>
                <textarea id="postContent" rows="12" class="w-full px-4 py-3 rounded-lg border font-mono text-sm leading-relaxed focus:ring-2 focus:ring-sky-200 outline-none" placeholder="åœ¨æ­¤è¼¸å…¥è‰ç¨¿..." oninput="updatePreview()"></textarea>
                
                <button id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-700 transition transform active:scale-[0.99]">ç¢ºèªç™¼å¸ƒæ–‡ç« </button>
            </div>

            <div class="hidden md:flex flex-1 flex-col bg-slate-50 overflow-y-auto">
                <div class="p-3 bg-white border-b font-bold text-gray-500 text-sm">å³æ™‚é è¦½</div>
                <div class="p-6">
                    <div class="bg-white rounded-xl shadow-sm p-8 max-w-lg mx-auto min-h-[500px]">
                        <h2 id="previewTitle" class="text-2xl font-bold mb-6 border-b-2 pb-4">æ–‡ç« æ¨™é¡Œ...</h2>
                        <div id="previewContent" class="preview-box"></div>
                    </div>
                </div>
            </div>
        </main>

        <main id="vipView" class="flex-1 hidden p-8 overflow-y-auto bg-gray-50">
            <div class="max-w-2xl mx-auto bg-white rounded-2xl p-8 border shadow-sm">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fas fa-user-plus text-emerald-500"></i> æ–°å¢å­¸å“¡ Email</h3>
                <div class="flex gap-4 mb-8">
                    <input type="email" id="vipEmailInput" placeholder="user@gmail.com" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-200 outline-none">
                    <button id="addVipBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 rounded-lg font-bold transition shadow">æ–°å¢</button>
                </div>
                <h3 class="text-lg font-bold mb-4 border-b pb-2">å­¸å“¡åå–® (<span id="vipCount">0</span>)</h3>
                <div id="vipListTable" class="divide-y border rounded-xl overflow-hidden shadow-sm max-h-[500px] overflow-y-auto bg-white"></div>
            </div>
        </main>
    </div>

    <div id="aiConfigModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border border-gray-200 animate-fade-in-up">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg flex items-center gap-2"><i class="fas fa-robot"></i> AI å¼•æ“ä¸­æ§å°</h3>
                <button onclick="document.getElementById('aiConfigModal').classList.add('hidden')" class="text-slate-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 text-sm text-blue-700 mb-2">
                    <i class="fas fa-info-circle mr-1"></i> è¨­å®šå°‡å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œå®‰å…¨æ–¹ä¾¿ã€‚
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ğŸŒŠ Perplexity API Key</label>
                    <input type="password" id="inputPerplexityKey" placeholder="pplx-..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-mono">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">â™Š Google Gemini API Key</label>
                    <input type="password" id="inputGeminiKey" placeholder="AIzaSy..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-mono">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t">
                <button onclick="document.getElementById('aiConfigModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold text-sm hover:text-gray-700">å–æ¶ˆ</button>
                <button id="saveKeysBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md transition"><i class="fas fa-save mr-1"></i> å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <script type="module">
        // âœ… [é—œéµä¿®æ­£] ä½¿ç”¨ä½ æˆªåœ–ä¸­çš„æ­£ç¢ºè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBi7FXRLt9qiVNa-qipPo-OD-b_qseQHUQ",
            authDomain: "gen-lang-client-0733075059.firebaseapp.com",
            projectId: "gen-lang-client-0733075059",
            storageBucket: "gen-lang-client-0733075059.firebasestorage.app",
            messagingSenderId: "561243064522",
            appId: "1:561243064522:web:cdfffd357c9af417b08c33",
            measurementId: "G-D93F1E1GR3"
        };
        const ADMIN_PASS = "0712";
        // ä½ çš„ Google Gemini Key (é è¨­)
        const DEFAULT_G_KEY = "AIzaSyCGJpnYdbgUVr0UW_OUfUxOV12gUro-pv4";
        const DEFAULT_P_KEY = ""; 

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        // âœ… [é—œéµä¿®æ­£] ä½¿ç”¨é è¨­è³‡æ–™åº« (ä¸åŠ åƒæ•¸)
        const db = getFirestore(app);

        // --- AI é¸å–®ç‹€æ…‹ç®¡ç† ---
        const modal = document.getElementById('aiConfigModal');
        const inputP = document.getElementById('inputPerplexityKey');
        const inputG = document.getElementById('inputGeminiKey');
        const selectMenu = document.getElementById('aiEngineSelect');

        function updateMenuStatus() {
            const pKey = localStorage.getItem('user_perplexity_key') || DEFAULT_P_KEY;
            const gKey = localStorage.getItem('user_gemini_key') || DEFAULT_G_KEY;
            
            const pReady = pKey && !pKey.includes('...');
            const gReady = gKey && !gKey.includes('...');

            selectMenu.options[0].text = pReady ? "âœ… Perplexity (æµ·ç´)" : "âŒ Perplexity (æœªè¨­å®š)";
            selectMenu.options[1].text = gReady ? "âœ… Google Gemini (æ–‡ç­†)" : "âŒ Google Gemini (æœªè¨­å®š)";

            const lastUsed = localStorage.getItem('last_used_engine');
            if (lastUsed) {
                selectMenu.value = lastUsed;
            } else if (!pReady && gReady) {
                selectMenu.value = 'gemini'; 
            }
        }

        function openConfigModal() {
            inputP.value = localStorage.getItem('user_perplexity_key') || "";
            inputG.value = localStorage.getItem('user_gemini_key') || "";
            modal.classList.remove('hidden');
        }

        document.getElementById('aiConfigBtn').addEventListener('click', openConfigModal);
        selectMenu.addEventListener('change', () => localStorage.setItem('last_used_engine', selectMenu.value));

        document.getElementById('saveKeysBtn').addEventListener('click', () => {
            const pKey = inputP.value.trim();
            const gKey = inputG.value.trim();
            if(pKey) localStorage.setItem('user_perplexity_key', pKey);
            if(gKey) localStorage.setItem('user_gemini_key', gKey);
            alert("âœ… é‡‘é‘°å·²å„²å­˜ï¼");
            modal.classList.add('hidden');
            updateMenuStatus();
        });

        updateMenuStatus();

        // --- ç™»å…¥èˆ‡æ¬Šé™ ---
        document.getElementById('loginBtn').addEventListener('click', () => {
            if (document.getElementById('passwordInput').value === ADMIN_PASS) {
                localStorage.setItem('littlesea_admin', 'true');
                location.reload();
            } else { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); }
        });
        document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.removeItem('littlesea_admin'); location.reload(); });

        if (localStorage.getItem('littlesea_admin') === 'true') {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('flex');
            signInAnonymously(auth).then(() => { loadPosts(); loadVIPs(); });
        }

        const switchTab = (target) => { 
            const postV = document.getElementById('postView'); 
            const vipV = document.getElementById('vipView'); 
            const tP = document.getElementById('tabPostBtn'); 
            const tV = document.getElementById('tabVipBtn'); 
            if (target === 'post') { 
                postV.classList.remove('hidden'); postV.classList.add('flex'); vipV.classList.add('hidden'); 
                tP.className = 'font-bold pb-1 border-b-2 border-sky-500 text-sky-600 transition'; tV.className = 'font-bold pb-1 text-gray-400 hover:text-gray-600 transition'; 
            } else { 
                postV.classList.add('hidden'); postV.classList.remove('flex'); vipV.classList.remove('hidden'); 
                tV.className = 'font-bold pb-1 border-b-2 border-sky-500 text-sky-600 transition'; tP.className = 'font-bold pb-1 text-gray-400 hover:text-gray-600 transition'; 
            } 
        };
        document.getElementById('tabPostBtn').addEventListener('click', () => switchTab('post'));
        document.getElementById('tabVipBtn').addEventListener('click', () => switchTab('vip'));

        function loadPosts() { 
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc")); 
            onSnapshot(q, (snapshot) => { 
                const list = document.getElementById('postListContainer'); 
                document.getElementById('postCount').innerText = snapshot.docs.length; 
                list.innerHTML = ''; 
                snapshot.forEach((docSnap) => { 
                    const post = docSnap.data(); 
                    const item = document.createElement('div'); 
                    item.className = 'bg-white p-3 rounded shadow-sm border mb-2 relative group hover:shadow-md transition cursor-pointer'; 
                    item.innerHTML = `
                        <div class="font-bold text-gray-700 line-clamp-1">${post.title || 'ç„¡æ¨™é¡Œ'}</div>
                        <div class="text-xs text-gray-400 mt-1 flex justify-between"><span>${post.category}</span></div>
                        <button onclick="event.stopPropagation(); window.delPost('${docSnap.id}')" class="absolute top-3 right-3 text-red-300 hover:text-red-600 transition opacity-0 group-hover:opacity-100"><i class="fas fa-trash-alt"></i></button>`; 
                    list.appendChild(item); 
                }); 
            }); 
        }
        window.delPost = async (id) => { if (confirm("ç¢ºå®šåˆªé™¤æ­¤æ–‡ç« ï¼Ÿ")) await deleteDoc(doc(db, "posts", id)); };

        function loadVIPs() { 
            onSnapshot(collection(db, "vip_members"), (snapshot) => { 
                const list = document.getElementById('vipListTable'); 
                document.getElementById('vipCount').innerText = snapshot.docs.length; 
                list.innerHTML = ''; 
                snapshot.forEach((docSnap) => { 
                    const vip = docSnap.data(); 
                    const div = document.createElement('div'); 
                    div.className = 'flex justify-between p-4 bg-white items-center hover:bg-slate-50 transition'; 
                    div.innerHTML = `<span class="font-mono text-gray-700">${vip.email}</span><button onclick="window.delVip('${docSnap.id}')" class="text-red-400 hover:text-red-600 font-bold text-sm"><i class="fas fa-times-circle"></i> ç§»å‡º</button>`; 
                    list.appendChild(div); 
                }); 
            }); 
        }
        document.getElementById('addVipBtn').addEventListener('click', async () => { 
            const email = document.getElementById('vipEmailInput').value.trim().toLowerCase(); 
            if (email) { await addDoc(collection(db, "vip_members"), { email, addedAt: serverTimestamp() }); document.getElementById('vipEmailInput').value = ''; alert("âœ… å·²æ–°å¢å­¸å“¡"); } 
        });
        window.delVip = async (id) => { if (confirm("ç¢ºå®šç§»å‡ºæ­¤å­¸å“¡ï¼Ÿ")) await deleteDoc(doc(db, "vip_members", id)); };

        document.getElementById('aiRewriteBtn').addEventListener('click', async () => {
            const content = document.getElementById('postContent').value;
            const category = document.querySelector('input[name="category"]:checked').value;
            const engine = selectMenu.value;
            
            const pKey = localStorage.getItem('user_perplexity_key') || DEFAULT_P_KEY;
            const gKey = localStorage.getItem('user_gemini_key') || DEFAULT_G_KEY;

            if (!content) return alert("è«‹å…ˆè¼¸å…¥ä¸€äº›è‰ç¨¿å…§å®¹...");
            if (engine === 'perplexity' && (!pKey || pKey.includes('...'))) {
                openConfigModal();
                return alert("âš ï¸ è«‹å…ˆè¨­å®š Perplexity Key");
            }
            if (engine === 'gemini' && (!gKey || gKey.includes('...'))) {
                openConfigModal();
                return alert("âš ï¸ è«‹å…ˆè¨­å®š Google Gemini Key");
            }

            const btn = document.getElementById('aiRewriteBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${engine === 'perplexity' ? 'æµ·ç´æ€è€ƒä¸­...' : 'Gemini æ’°å¯«ä¸­...'}`;

            const systemPrompt = `ä½ ç¾åœ¨æ˜¯ã€Œå°æµ·